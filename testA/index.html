<!doctype html>
<html>
	<head>
		<title> Socket.IO chat </title>


	</head>
	<body>
		
		<script src = "/socket.io/socket.io.js"></script>
		<script src="http://code.jquery.com/jquery-1.11.1.js"></script>

<script>

// var midi = require("../midi.js");

// var input = new midi.input();
// console.log(input.getPortCount());
// console.log(input.getPortName(0));
// input.on('message', function(deltaTime, message) {
//   //console.log('m:' + message + ' d:' + deltaTime);

// var send0 = message[0] ;
// var send1 = message[1] ;
// var send2 = message[2] ;
// var send = new Buffer(send0 + " " + send1 + " " + send2) ;

// // console.log(message[0]) ;
// // console.log(message[1]) ;
// // console.log(message[2]) ;

// //console.log(send) ;
//   // output.sendMessage(message) ;
//   // client1.send(send, 0, send.length, PORT, HOST, function(err, bytes) {
//   //   if (err) throw err;
//   //   console.log('UDP message sent to ' + HOST +':'+ PORT);
//   //   console.log(send) ;
//     //client.close();

//  // }); // end client send 

// });
// input.openPort(0);


// Create socket
var socket = io() ;

// initialize web audio api
var context = new (window.AudioContext || window.webkitAudioContext)();

var soundOn ;
var soundOff ;
var isPlaying = false;

$(document).keydown(function(e) { 
  if (isPlaying) return;
  isPlaying = true;
	on = e.which;
	socket.emit('message on', on);
	return false;
});

$(document).keyup(function(e) { 
  isPlaying = false;
});
$(document).focus(function(e) { 
  isPlaying = false;
});

// send keypress event
// $(document).keypress(function(e){

// 	if (e == null) { on = event.keyCode;}  
//     else {  on = e.which;}
// 	socket.emit('message on', on);
// 	return false;
// });

// send keyup event
// $(document).keyup(function(e){
// 	off = e.which;
// 	socket.emit('message off', off);
// 	return false;
// });


// Receive and process message
socket.on('message on', function(msgOn){
	startNote(msgOn) ;
	});

// socket.on('message off', function(msgOff){
// 	startNote(msgOff) ;
// });

// socket.on('message off', function(msgOff){
// 	noteOff = msgOff ;
// });

// if (!isPlaying)
// {
function startNote(soundOn)
{
	oscillator = context.createOscillator(); // Create bass guitar
    gainNode = context.createGainNode(); // Create boost pedal
 
	oscillator.connect(gainNode); // Connect bass guitar to boost pedal
	gainNode.connect(context.destination); // Connect boost pedal to amplifier
	gainNode.gain.value = 0.3; // Set boost pedal to 30 percent volume

	console.log(soundOn) ;

	if (soundOn == 97)
	{
		oscillator.frequency.value = 440.00; // A
		oscillator.noteOn(0); // Play bass guitar instantly
		//isPlaying = true ;
// setTimeout(function(){
// 		oscillator.noteOff(0); // Play bass guitar instantly
// 		oscillator.disconnect();
// 			}, 100);
	}
	else if (soundOn == 98)
	{
		oscillator.frequency.value = 493.88; // B
		oscillator.noteOn(0);
		isPlaying = true ;
		// setTimeout(function(){
		// oscillator.noteOff(0); // Play bass guitar instantly
		// oscillator.disconnect();
		// 	}, 100);
	}
	else if (soundOn == 99)
	{
		oscillator.frequency.value = 523.25; // C
		oscillator.noteOn(0);
		isPlaying = true ;
		// setTimeout(function(){
		// oscillator.noteOff(0); // Play bass guitar instantly
		// oscillator.disconnect();
		// 	}, 100);
	}
	else if (soundOn = 100)
	{
		oscillator.frequency.value = 587.33; // D
		oscillator.noteOn(0) ;
		isPlaying = true ;
		setTimeout(function(){
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
			}, 100);
	}
	else if (soundOn = 101)
	{
		oscillator.frequency.value = 659.25; // E
		oscillator.noteOn(0) ;
		isPlaying = true ;
		setTimeout(function(){
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
			}, 100);
	}

$(document).keyup(function(e){
	off = e.which;
	socket.emit('message off', off);
	isPlaying = false ;
	return false;
});

socket.on('message off', function(msgOff){
	endNote(msgOff, oscillator) ;
});

}

// }

function endNote(soundOff, oscillator)
{
	if (soundOff == 65)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
		isPlaying = false ;
	}
	else if (soundOff == 66)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
		isPlaying = false ;
	}
	else if (soundOff == 99)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
		isPlaying = false ;
	}
	else if (soundOff = 100)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
		isPlaying = false ;
	}
	else if (soundOff = 101)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
		isPlaying = false ;
	}
}


		</script>
	</body>
</html>