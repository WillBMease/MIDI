<!doctype html>
<html>
	<head>
		<title> Socket.IO chat </title>

		 <!-- <script src="js/WebMIDIAPI.js"></script>
		// <script src = "js/audioTriggers.js" type = "text/javascript"></script> -->

  <link rel="stylesheet" href="css/style.css">
  <link href="css/fancy.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>

		 <script src="js/WebMIDIAPI.js"></script>
<!-- 		 // <script src="js/videochatroom.js"></script> -->


	</head>

	<body>

<a class = "inavibe">
inavibe</a>
<h2>
<a style "color: white" class = "choose-inst" onClick = "generateNotes(bass)"><i>bass</i>
<a class = "choose-inst" onClick = "generateNotes(harp)"><i>harp</i></a>
<!-- <a class = "choose-inst" onClick = "newGenerateNotes(newHarp)"><i>new harp</i></a> -->
<a class = "choose-inst" onClick = "generateNotes(gPiano)"><i>piano</i></a>
<a class = "choose-inst" onClick = "generateNotes(jazzdrums)"><i>drums</i></a>
<a onclick = "initiateOsc()"><i>synth</i><a>
<a class = "midi-pos" onclick = "runTest();" ><i>midi</i></a>
</h2>
<!-- <h3><a class = "midi-pos-download" href = "http://jazz-soft.net/"> download MIDI support</a></h3> -->
<h4>
	<pre id="log">
	</pre>
	<div class = "midi-pos" id="MIDIPlugin" style="position:absolute; visibility:hidden"></div>
</h4>




</div>
	<ul class="audioBin">
	<li></li>

	</ul>
	<ul class="audioBin1">
	<li></li>

	</ul>
	<ul class="audioBin2">
	<li></li>

	</ul>
</div> 


<!-- 		// <script src = "/socket.io/socket.io.js"></script> -->
		<script src = "http://code.jquery.com/jquery-1.11.1.js"></script>
		<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>-->

<script>

var octave = 1;
var globalOctave;

//variable used to 
var midiActive = false;
var sampleActive = false;

// initialize web audio api
var context = new (window.AudioContext || window.webkitAudioContext ||  
	window.mozAudioContext || 
    window.oAudioContext || 
    window.msAudioContext)();
if (context) {
  // Web Audio API is available.
} else {
  alert('browser not supported') ;
}

var soundOn ;
var soundOff ;
var isPlaying = false;

var latencyActive = false;
var latencyCount ;
var conn ;


var instrument; 
instrument = '<audio id="" preload="auto">' +
			'</audio>';

//preset instrumemt list/////////////////////////////

var harp = { "name" : "harp", "octaveNum": 8, "notes": 96, "path" : "sounds/Harp"};

// var newHarp = { "name" : "newHarp", "octaveNum": 8, "notes": 97, "path" : "sounds/newHarp"};

var bass = { "name": "bass", "octaveNum": 4, "notes" : 48, "path" : "sounds/E-Bass_Guitar"};

var gPiano = { "name" : "gPiano" , "octaveNum": 8, "notes": 96, "path" : "sounds/Grand_Piano"};

var jazzdrums = { "name" : "drums" , "octaveNum": 2, "notes": 17, "path" : "sounds/jazzdrums"};

$(document).keypress(function(e) { 
if(!sampleActive){
  if (isPlaying) {
  	return; }
  
  isPlaying = true;
	on = e.which;
	return false;
}

else {
	var pressed = e.which;

	if (conn[0] != 0)
	{
		conn[0].send(pressed);
		console.log("send 0");
	}
	if (conn[1] != 0)
	{
		conn[1].send(pressed);
			console.log("send 1");
	}
	if (conn[2] != 0)
	{
		conn[2].send(pressed);
			console.log("send 2");
	}
}

});

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// SAMPLES
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////



function transpose(noteInput){
	// 1
	if(noteInput == 49 && octave < globalOctave){
		octave = octave + 1;
	}
	// ~
	if(noteInput == 96 && octave != 0){
		octave = octave - 1;
	}
}


function keyGlow(cssClass){
	$('.active').removeClass(active);
	$(this).addClass('active');
	$('.button').click(function(){
	})
}


//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// MIDI
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////




var midi=null;
var inputs=null;
var outputs=null;
var input=null;
var output=null;
var log=null;

function runTest() {
	if (!log)
		log = document.getElementById("log");
	 log.innerText = "Starting up MIDI...\n";
	navigator.requestMIDIAccess().then( success, failure );
}

function handleMIDIMessage( ev ) {
	
		var midiMsg = [] ;
		midiMsg[0] = ev.data[0].toString(16) ;
		midiMsg[1] = ev.data[1].toString(16) ;
		midiMsg[2] = ev.data[2].toString(16) ;
		//midiMsg[3] = new Date() ;

		if (conn[0] != 0)
		{
		conn[0].send(midiMsg);
		console.log("send 0");
	}
		if (conn[1] != 0)
		{
		conn[1].send(midiMsg);
			console.log("send 1");
		}
		if (conn[2] != 0)
		{
		conn[2].send(midiMsg);
			console.log("send 2");
		}



// Plays the drum note through MIDI output (Apple DLS Synth)
	// if (output)
	// 	output.send( ev.data );
}

function success( midiAccess ) {
	 log.innerText += "MIDI ready!\n";
	midi = midiAccess;

	inputs = midi.inputs();
	log.innerText += inputs.length+" inputs:\n";
	for (var i=0;i<inputs.length;i++)
		log.innerText += i + ": " + inputs[i].name + "\n";

	if (inputs.length>0) {
		input = inputs[0];
		input.onmessage = handleMIDIMessage;
		input.addEventListener("midimessage", handleMIDIMessage);
		log.innerText += inputs[0] + "Hooked up first input.\n";
	}

	outputs = midi.outputs();
	log.innerText += outputs.length+" outputs:\n";
	for (var i=0;i<outputs.length;i++)
		log.innerText += i + ": " + outputs[i].name + "\n";

	if (outputs.length) {
		output = outputs[0];
		output.send( [0xb0, 0x00, 0x7f] );	// If the first device is a Novation Launchpad, this will light it up!
	}
}

function failure( error ) {
	alert( "Failed to initialize MIDI - " + ((error.code==1) ? "permission denied" : ("error code " + error.code)) );
}

// function playMidi(midiNote)
// {
// 	if (midiNote[2] != '0')
// 		{
// 		console.log("playMidi was called");
// 		var note;
// 		note = masterConversion(midiNote);
// 		playMidiNote(note);
// 	}
// }

</script>


		
		<script src="js/sampleMapping.js"></script>
		<script src="js/webrtc.js"></script>


  Your PeerJS id is : <span id="pid"></span><br><br>
  Connect to peer: <input type="text" id="rid" placeholder="Someone else's id">
                   <input type="button" value="Connect" id="connect"><br><br>
  
  
  <div id="chat_area" style="display: none;">
    <div id="messages"></div>
    <input type="text" id="text" placeholder="Enter message">
    <input type="button" value="Send" id="send">
  </div>
  
  <center>
    <h1>Video Chat Room</h1>
    <div id="mypeerid"></div>
    <input id="remotepeerid" type="text" placeholder="Enter peer id"/>
    <button id="call" type="button">Call</button>
  </center>

  <div id="videos"></div>

	</body>
</html>