<!doctype html>
<html>
	<head>
		<title> Socket.IO chat </title>

		 <!-- <script src="js/WebMIDIAPI.js"></script>
		// <script src = "js/audioTriggers.js" type = "text/javascript"></script> -->

  <link rel="stylesheet" href="css/style.css">
  <link href="css/fancy.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>

		 <script src="js/WebMIDIAPI.js"></script>
<!-- 		 // <script src = "js/audioTriggers.js" type = "text/javascript"></script> -->



<script>

 var conn;
  // Connect to PeerJS, have server assign an ID instead of providing one
  
  // Generate random ID between 1 and 50 for the user
  var randID = Math.floor(Math.random() * 50) + 1 ;

  // Create a new peer, and assign the randID as "label" in peer
  var peer = new Peer(randID, {key: 'lwjd5qra8257b9', debug: true});

  // Open the peer using the randID "label" we assigned
  peer.on('open', function(label){
    $('#pid').text(label);
  });  

  // Await connections from others
  peer.on('connection', connect);

  // Function called from line above ^
  function connect(c) {
    $('#chat_area').show();

    // Assign the connection to the user (array for multiple connections?)
    conn = c;
    $('#messages').empty().append('Now chatting with ' + conn.peer);

    // Receive the incoming message and play it calling midi function
    conn.on('data', function(data){
      $('#messages').append('<br>' + conn.peer + ':<br>' + data);
      playMidi(data) ;
    });

    // Close the connection if other peer leaves
    conn.on('close', function(err){ alert(conn.peer + ' has left the chat.') });
  }
  $(document).ready(function() {
    // Conect to a peer
    $('#connect').click(function(){
      var c = peer.connect($('#rid').val());
      c.on('open', function(){
        connect(c);
      });
      c.on('error', function(err){ alert(err) });  
    });
    // Send a chat message
    $('#send').click(function(){
      // var msg = $('#text').val();
      var msg = 'hey' ;
      conn.send(msg);
      $('#messages').append('<br>You:<br>' + msg);
      $('#text').val('');
    });
    // Show browser version
    $('#browsers').text(navigator.userAgent);
  });

</script>



	</head>

	<body>

<a class = "inavibe">
inavibe</a>
<h2>
<a style "color: white" class = "choose-inst" onClick = "generateNotes(bass)"><i>bass</i>
<a class = "choose-inst" onClick = "generateNotes(harp)"><i>harp</i></a>
<a class = "choose-inst" onClick = "generateNotes(gPiano)"><i>piano</i></a>
<a onclick = "initiateOsc()"><i>synth</i><a>
<a class = "midi-pos" onclick = "runTest();" ><i>midi</i></a>
</h2>
<h3><a class = "midi-pos-download" href = "http://jazz-soft.net/"> download MIDI support</a></h3>
<h4>
	<pre id="log">
	</pre>
	<div class = "midi-pos" id="MIDIPlugin" style="position:absolute; visibility:hidden"></div>
</h4>

<!-- <div class = "latency" onclick = "startLatency()"><i> Start Latency </i></div> -->


<h1 class = "note-pos">

<i>
	A
</i>
<i>
	B
</i>
<i>
	C
</i>
<i>
	D
</i>
<i>
	E
</i>
<i>
	F
</i>

</h1>


</div>
	<ul class="audioBin">
	<li></li>

	</ul>
</div> 


		<script src = "/socket.io/socket.io.js"></script>
		<script src = "http://code.jquery.com/jquery-1.11.1.js"></script>
		<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>-->

<script>

// Create socket
var socket = io() ;

var octave = 1;
var globalOctave;

//variable used to 
var midiActive = false;
var sampleActive = false;

// initialize web audio api
var context = new (window.AudioContext || window.webkitAudioContext ||  
	window.mozAudioContext || 
    window.oAudioContext || 
    window.msAudioContext)();
if (context) {
  // Web Audio API is available.
} else {
  alert('browser not supported') ;
}

var soundOn ;
var soundOff ;
var isPlaying = false;

var latencyActive = false;
var latencyCount ;
var conn ;


var instrument; 
instrument = '<audio id="" preload="auto">' +
			'</audio>';

//preset instrumemt list/////////////////////////////

var harp = { "name" : "harp", "octaveNum": 5, "notes": 57, "path" : "sounds/Harp"};

var bass = { "name": "bass", "octaveNum": 3, "notes" : 31, "path" : "sounds/E-Bass_Guitar"};

var gPiano = { "name" : "gPiano" , "octaveNum": 6, "notes": 73, "path" : "sounds/Grand_Piano"};

$(document).keypress(function(e) { 
if(!sampleActive){
  if (isPlaying) {
  	return; }
  
  isPlaying = true;
	on = e.which;
	socket.emit('osc on', on);
	return false;
}

else {
	var pressed = e.which;
	//socket.emit('sample on', pressed);
	conn.send(pressed) ;
	console.log(pressed);
    triggerSample(pressed);
}

});

function keyMap(e,delay) {
  var pressed = e.which;
	triggerSample(pressed, delay);
	console.log(pressed);
}

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// OSCILLATOR
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

function initiateOsc(){
	sampleActive = false;
}

function startNote(soundOn)
{
	oscillator = context.createOscillator(); // Create bass guitar
    gainNode = context.createGainNode(); // Create boost pedal
 
	oscillator.connect(gainNode); // Connect bass guitar to boost pedal
	gainNode.connect(context.destination); // Connect boost pedal to amplifier
	gainNode.gain.value = 0.3; // Set boost pedal to 30 percent volume

	console.log(soundOn) ;

	if (soundOn == 97)
	{
		oscillator.frequency.value = 440.00; // A
		oscillator.noteOn(0); // Play bass guitar instantly
	}
	else if (soundOn == 98)
	{
		oscillator.frequency.value = 493.88; // B
		oscillator.noteOn(0);
	}
	else if (soundOn == 99)
	{
		oscillator.frequency.value = 523.25; // C
		oscillator.noteOn(0);
	}
	else if (soundOn == 100)
	{
		oscillator.frequency.value = 587.33; // D
		oscillator.noteOn(0) ;
	}
	else if (soundOn == 101)
	{
		oscillator.frequency.value = 659.25; // E
		oscillator.noteOn(0) ;
	}

$(document).keyup(function(e){
	off = e.which;
	socket.emit('osc off', off);
	isPlaying = false ;
	return false;
});
$(document).focus(function(e) { 
  isPlaying = false;
});

socket.on('osc off', function(msgOff){
	endNote(msgOff, oscillator) ;
});

}

function endNote(soundOff, oscillator)
{
	if (soundOff == 65)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 66)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 67)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 68)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 69)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
}


//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// SAMPLES
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////



function transpose(noteInput){
	// 1
	if(noteInput == 49 && octave < globalOctave){
		octave = octave + 1;
	}
	// ~
	if(noteInput == 96 && octave != 0){
		octave = octave - 1;
	}
}


function keyGlow(cssClass){
	$('.active').removeClass(active);
	$(this).addClass('active');
	$('.button').click(function(){
	})
}


//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// MIDI
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////




var midi=null;
var inputs=null;
var outputs=null;
var input=null;
var output=null;
var log=null;

function runTest() {
	if (!log)
		log = document.getElementById("log");
	 log.innerText = "Starting up MIDI...\n";
	navigator.requestMIDIAccess().then( success, failure );
}

function handleMIDIMessage( ev ) {
	
		var midiMsg = [] ;
		midiMsg[0] = ev.data[0].toString(16) ;
		midiMsg[1] = ev.data[1].toString(16) ;
		midiMsg[2] = ev.data[2].toString(16) ;
		midiMsg[3] = new Date() ;
		conn.send(midiMsg);

    // conn.on('data', function(retLat){
    //   var lat = new Date() ;
    //   var total = lat - retLat[3] ;
    //   console.log ('latency: ' + total) ;
    // });

// Plays the drum note through MIDI output (Apple DLS Synth)
	// if (output)
	// 	output.send( ev.data );
}

function success( midiAccess ) {
	 log.innerText += "MIDI ready!\n";
	midi = midiAccess;

	inputs = midi.inputs();
	log.innerText += inputs.length+" inputs:\n";
	for (var i=0;i<inputs.length;i++)
		log.innerText += i + ": " + inputs[i].name + "\n";

	if (inputs.length>0) {
		input = inputs[0];
		input.onmessage = handleMIDIMessage;
		input.addEventListener("midimessage", handleMIDIMessage);
		log.innerText += inputs[0] + "Hooked up first input.\n";
	}

	outputs = midi.outputs();
	log.innerText += outputs.length+" outputs:\n";
	for (var i=0;i<outputs.length;i++)
		log.innerText += i + ": " + outputs[i].name + "\n";

	if (outputs.length) {
		output = outputs[0];
		output.send( [0xb0, 0x00, 0x7f] );	// If the first device is a Novation Launchpad, this will light it up!
	}
}

function failure( error ) {
	alert( "Failed to initialize MIDI - " + ((error.code==1) ? "permission denied" : ("error code " + error.code)) );
}

function playMidi(midiNote)
{
	if (midiNote[2] != '0')
		{

		switch (midiNote[1])
		{
			case '24' : log.innerText = "C2" ;
			triggerMidiDevice(122) ;
			break ;
			case '25' : log.innerText = "C#2" ;
			triggerMidiDevice(115) ;
			break ;
			case '26' : log.innerText = "D2" ;
			triggerMidiDevice(120) ;
			break ;
			case '27' : log.innerText = "D#2" ;
			triggerMidiDevice(100) ;
			break ;
			case '28' : log.innerText = "E2" ;
			triggerMidiDevice(99) ;
			break ;
			case '29' : log.innerText = "F2" ;
			triggerMidiDevice(118) ;
			break ;
			case '2a' : log.innerText = "F#2" ;
			triggerMidiDevice(103) ;
			break ;
			case '2b' : log.innerText = "G2" ;
			triggerMidiDevice(98) ;
			break ;
			case '2c' : log.innerText = "G#2" ;
			triggerMidiDevice(104) ;
			break ;
			case '2d' : log.innerText = "A2" ;
			triggerMidiDevice(106) ;
			break ;
			case '2e' : log.innerText = "A#2" ;
			triggerMidiDevice(109) ;
			break ;
			case '2f' : log.innerText = "B2" ;
			triggerMidiDevice(44) ;
			break ;
			case '30' : log.innerText = "C3" ;
			triggerMidiDevice(108) ;
			break ;
			case '31' : log.innerText = "C#3" ;
			triggerMidiDevice(46) ;
			break ;
			case '32' : log.innerText = "D3" ;
			triggerMidiDevice(59) ;
			break ;
			case '33' : log.innerText = "D#3" ;
			triggerMidiDevice(47) ;
			break ;
			case '34' : log.innerText = "E3" ;
			triggerMidiDevice(114) ;
			break ;
			case '35' : log.innerText = "F3" ;
			triggerMidiDevice(53) ;
			break ;
			case '36' : log.innerText = "F#3" ;
			triggerMidiDevice(116) ;
			break ;
			case '37' : log.innerText = "G3" ;
			triggerMidiDevice(54) ;
			break ;
			case '38' : log.innerText = "G#3" ;
			triggerMidiDevice(121) ;
			break ;
			case '39' : log.innerText = "A3" ;
			triggerMidiDevice(55) ;
			break ;
			case '3a' : log.innerText = "A#3" ;
			triggerMidiDevice(53) ;
			break ;
			case '3b' : log.innerText = "B3" ;
			break ;
			case '3c' : log.innerText = "C4" ;
			break ;
			case '3d' : log.innerText = "C#4" ;
			break ;
			case '3e' : log.innerText = "D4" ;
			break ;
			case '3f' : log.innerText = "D#4" ;
			break ;
			case '40' : log.innerText = "E4" ;
			break ;
			case '41' : log.innerText = "F4" ;
			break ;
			case '42' : log.innerText = "F#4" ;
			break ;
			case '43' : log.innerText = "G4" ;
			break ;
			case '44' : log.innerText = "G#4" ;
			break ;
			case '45' : log.innerText = "A4" ;
			break ;
			case '46' : log.innerText = "A#4" ;
			break ;
			case '47' : log.innerText = "B4" ;
			break ;
			case '48' : log.innerText = "C5" ;
			break ;
			case '49' : log.innerText = "C#5" ;
			break ;
			case '4a' : log.innerText = "D5" ;
			break ;
			case '4b' : log.innerText = "D#5" ;
			break ;
			case '4c' : log.innerText = "E5" ;
			break ;
			case '4d' : log.innerText = "F5" ;
			break ;
			case '4e' : log.innerText = "F#5" ;
			break ;
			case '4f' : log.innerText = "G5" ;
			break ;
			case '50' : log.innerText = "G#5" ;
			break ;
			case '51' : log.innerText = "A5" ;
			break ;
			case '52' : log.innerText = "A#5" ;
			break ;
			case '53' : log.innerText = "B5" ;
			break ;
			case '54' : log.innerText = "C6" ;
		}
		}
		else
		{
			
		}
}

</script>


		
		<script src="js/sampleMapping.js"></script>


  Your PeerJS id is : <span id="pid"></span><br><br>
  Connect to peer: <input type="text" id="rid" placeholder="Someone else's id">
                   <input type="button" value="Connect" id="connect"><br><br>
  
  
  <div id="chat_area" style="display: none;">
    <div id="messages"></div>
    <input type="text" id="text" placeholder="Enter message">
    <input type="button" value="Send" id="send">
  </div>
  


	</body>
</html>