<!doctype html>
<html>
	<head>
		<title> Socket.IO chat </title>

		 <!-- <script src="js/WebMIDIAPI.js"></script>
		// <script src = "js/audioTriggers.js" type = "text/javascript"></script> -->

  <link rel="stylesheet" href="css/style.css">
  <link href="css/fancy.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>

		 <script src="js/WebMIDIAPI.js"></script>
<!-- 		 // <script src = "js/audioTriggers.js" type = "text/javascript"></script> -->



<script>

 var conn;
  // Connect to PeerJS, have server assign an ID instead of providing one
   //var randID = Math.floor(Math.random() * 50) + 1 ;
  //var randID = '21' ;
  // console.log(randID) ;
  var peer = new Peer({key: 'lwjd5qra8257b9', debug: true});
  // peer.metadata = randID ;
  peer.on('open', function(id){
    $('#pid').text(id);
  });  
  // Await connections from others
  peer.on('connection', connect);
  function connect(c) {
    $('#chat_area').show();
    conn = c;
    $('#messages').empty().append('Now chatting with ' + conn.peer);
    conn.on('data', function(data){
      $('#messages').append('<br>' + conn.peer + ':<br>' + data);
    });
    conn.on('close', function(err){ alert(conn.peer + ' has left the chat.') });
  }
  $(document).ready(function() {
    // Conect to a peer
    $('#connect').click(function(){
      var c = peer.connect($('#rid').val());
      c.on('open', function(){
        connect(c);
      });
      c.on('error', function(err){ alert(err) });  
    });
    // Send a chat message
    $('#send').click(function(){
      // var msg = $('#text').val();
      var msg = 'hey' ;
      conn.send(msg);
      $('#messages').append('<br>You:<br>' + msg);
      $('#text').val('');
    });
    // Show browser version
    $('#browsers').text(navigator.userAgent);
  });

</script>



	</head>

	<body>

<a class = "inavibe">
inavibe</a>
<h2>
<a style "color: white" class = "choose-inst" onClick = "generateNotes(bass)"><i>bass</i>
<a class = "choose-inst" onClick = "generateNotes(harp)"><i>harp</i></a>
<a class = "choose-inst" onClick = "generateNotes(gPiano)"><i>piano</i></a>
<a onclick = "initiateOsc()"><i>synth</i><a>
<a class = "midi-pos" onclick = "runTest();" ><i>midi</i></a>
</h2>
<h3><a class = "midi-pos-download" href = "http://jazz-soft.net/"> download MIDI support</a></h3>
<h4>
	<pre id="log">
	</pre>
	<div class = "midi-pos" id="MIDIPlugin" style="position:absolute; visibility:hidden"></div>
</h4>

<div class = "latency" onclick = "startLatency()"><i> Start Latency </i></div>


<h1 class = "note-pos">

<i>
	A
</i>
<i>
	B
</i>
<i>
	C
</i>
<i>
	D
</i>
<i>
	E
</i>
<i>
	F
</i>

</h1>


</div>
	<ul class="audioBin">
	<li></li>

	</ul>
</div> 


		<script src = "/socket.io/socket.io.js"></script>
		<script src = "http://code.jquery.com/jquery-1.11.1.js"></script>
		<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>-->

<script>

// Create socket
var socket = io() ;

var octave = 1;
var globalOctave;

//variable used to 
var midiActive = false;
var sampleActive = false;

// initialize web audio api
var context = new (window.AudioContext || window.webkitAudioContext ||  
	window.mozAudioContext || 
    window.oAudioContext || 
    window.msAudioContext)();
if (context) {
  // Web Audio API is available.
} else {
  alert('browser not supported') ;
}

var soundOn ;
var soundOff ;
var isPlaying = false;

var latencyActive = false;
var latencyCount ;
var conn ;


var instrument; 
instrument = '<audio id="" preload="auto">' +
			'</audio>';

//preset instrumemt list/////////////////////////////

var harp = { "name" : "harp", "octaveNum": 5, "notes": 57, "path" : "sounds/Harp"};

var bass = { "name": "bass", "octaveNum": 3, "notes" : 31, "path" : "sounds/E-Bass_Guitar"};

var gPiano = { "name" : "gPiano" , "octaveNum": 6, "notes": 73, "path" : "sounds/Grand_Piano"};

$(document).keypress(function(e) { 
if(!sampleActive){
  if (isPlaying) {
  	return; }
  
  isPlaying = true;
	on = e.which;
	socket.emit('osc on', on);
	return false;
}

else {
	var pressed = e.which;
	//socket.emit('sample on', pressed);
	//conn.send(pressed) ;
	console.log(pressed);
    triggerSample(pressed);
}

});

function keyMap(e,delay) {
  var pressed = e.which;
	triggerSample(pressed, delay);
	console.log(pressed);
}

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// OSCILLATOR
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

function initiateOsc(){
	sampleActive = false;
}

function startNote(soundOn)
{
	oscillator = context.createOscillator(); // Create bass guitar
    gainNode = context.createGainNode(); // Create boost pedal
 
	oscillator.connect(gainNode); // Connect bass guitar to boost pedal
	gainNode.connect(context.destination); // Connect boost pedal to amplifier
	gainNode.gain.value = 0.3; // Set boost pedal to 30 percent volume

	console.log(soundOn) ;

	if (soundOn == 97)
	{
		oscillator.frequency.value = 440.00; // A
		oscillator.noteOn(0); // Play bass guitar instantly
	}
	else if (soundOn == 98)
	{
		oscillator.frequency.value = 493.88; // B
		oscillator.noteOn(0);
	}
	else if (soundOn == 99)
	{
		oscillator.frequency.value = 523.25; // C
		oscillator.noteOn(0);
	}
	else if (soundOn == 100)
	{
		oscillator.frequency.value = 587.33; // D
		oscillator.noteOn(0) ;
	}
	else if (soundOn == 101)
	{
		oscillator.frequency.value = 659.25; // E
		oscillator.noteOn(0) ;
	}

$(document).keyup(function(e){
	off = e.which;
	socket.emit('osc off', off);
	isPlaying = false ;
	return false;
});
$(document).focus(function(e) { 
  isPlaying = false;
});

socket.on('osc off', function(msgOff){
	endNote(msgOff, oscillator) ;
});

}

function endNote(soundOff, oscillator)
{
	if (soundOff == 65)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 66)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 67)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 68)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 69)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
}


//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// SAMPLES
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////



function transpose(noteInput){
	// 1
	if(noteInput == 49 && octave < globalOctave){
		octave = octave + 1;
	}
	// ~
	if(noteInput == 96 && octave != 0){
		octave = octave - 1;
	}
}


function keyGlow(cssClass){
	$('.active').removeClass(active);
	$(this).addClass('active');
	$('.button').click(function(){
	})
}


// function keyboardMap(keyInput)
// {
// 	var output;
// 	// z
// 	if(keyInput == 122){
// 		output = 1;
// 	}
// 	// s
// 	else if (keyInput == 115) {
// 		output = 2;
// 	}
// 	// x
// 	else if (keyInput == 120) {
// 		output = 3;
// 	}
// 	// d
// 	else if (keyInput == 100) {
// 		output = 4;
// 	}
// 	// c
// 	else if (keyInput == 99) {
// 		output = 5;
// 	}
// 	// v
// 	else if (keyInput == 118) {
// 		output = 6;
// 	}
// 	// g
// 	else if (keyInput == 103) {
// 		output = 7;
// 	}
// 	// b
// 	else if (keyInput == 98) {
// 		output = 8;
// 	}
// 	// h
// 	else if (keyInput == 104) {
// 		output = 9;
// 	}
// 	// n
// 	else if (keyInput == 110) {
// 		output = 10;
// 	}
// 	// j
// 	else if (keyInput == 106) {
// 		output = 11;
// 	}
// 	// m
// 	else if (keyInput == 109) {
// 		output = 12;
// 	}

// ///////////////////////////// Next Octave /////////////////////////////////
// 	// < OR q
// 	else if (keyInput == 44 || keyInput == 113) {
// 		output = 13;
// 	}
// 	// l OR 2
// 	else if (keyInput == 108 || keyInput == 50) {
// 		output = 14;
// 	}
// 	// > OR w
// 	else if (keyInput == 46 || keyInput == 119) {
// 		output = 15;
// 	}
// 	// ; OR 3
// 	else if (keyInput == 59 || keyInput == 51) {
// 		output = 16;
// 	}
// 	// ? OR e
// 	else if (keyInput == 47 || keyInput == 101) {
// 		output = 17;
// 	}
// 	// r
// 	else if (keyInput == 114) {
// 		output = 18;
// 	}
// 	// 5
// 	else if (keyInput == 53) {
// 		output = 19;
// 	}
// 	// t
// 	else if (keyInput == 116) {
// 		output = 20;
// 	}
// 	// 6
// 	else if (keyInput == 54) {
// 		output = 21;
// 	}
// 	// y
// 	else if (keyInput == 121) {
// 		output = 22;
// 	}
// 	// 7
// 	else if (keyInput == 55) {
// 		output = 23;
// 	}
// 	// u
// 	else if (keyInput == 117) {
// 		output = 24;
// 	}

// /////////////////////// Start of the next Octave /////////////////////////

// 	// i
// 	else if (keyInput == 105) {
// 		output = 25;
// 	}
// 	// 9
// 	else if (keyInput == 57) {
// 		output = 26;
// 	}
// 	// o
// 	else if (keyInput == 111) {
// 		output = 27;
// 	}
// 	// 0
// 	else if (keyInput == 48) {
// 		output = 28;
// 	}
// 	// p
// 	else if (keyInput == 112) {
// 		output = 29;
// 	}
// 	// {
// 	else if (keyInput == 91) {
// 		output = 30;
// 	}
// 	// +
// 	else if (keyInput == 61) {
// 		output = 31;
// 	}
// 	// }
// 	else if (keyInput == 93) {
// 		output = 32;
// 	}

// 	else{
// 		output = 200;
// 	}
// 	return output;
// }


//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// MIDI
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////




var midi=null;
var inputs=null;
var outputs=null;
var input=null;
var output=null;
var log=null;

function runTest() {
	if (!log)
		log = document.getElementById("log");
	 log.innerText = "Starting up MIDI...\n";
	navigator.requestMIDIAccess().then( success, failure );
}

function handleMIDIMessage( ev ) {
	// testing - just reflect.
	// log.innerText += "Message: " + ev.data.length + " bytes, timestamp: " + ev.timestamp;
	if (ev.data.length == 3) 
	{
		log.innerText += " " + ev.data[0].toString(16) + " " + ev.data[1].toString(16) + " " + ev.data[2].toString(16);

		switch (ev.data[1].toString(16))
		{
			case '24' : log.innerText = "C2" ;
			triggerSample(122) ;
			break ;
			case '25' : log.innerText = "C#2" ;
			triggerSample(115) ;
			break ;
			case '26' : log.innerText = "D2" ;
			triggerSample(120) ;
			break ;
			case '27' : log.innerText = "D#2" ;
			triggerSample(100) ;
			break ;
			case '28' : log.innerText = "E2" ;
			triggerSample(99) ;
			break ;
			case '29' : log.innerText = "F2" ;
			triggerSample(118) ;
			break ;
			case '2a' : log.innerText = "F#2" ;
			triggerSample(103) ;
			break ;
			case '2b' : log.innerText = "G2" ;
			break ;
			case '2c' : log.innerText = "G#2" ;
			break ;
			case '2d' : log.innerText = "A2" ;
			break ;
			case '2e' : log.innerText = "A#2" ;
			break ;
			case '2f' : log.innerText = "B2" ;
			break ;
			case '30' : log.innerText = "C3" ;
			break ;
			case '31' : log.innerText = "C#3" ;
			break ;
			case '32' : log.innerText = "D3" ;
			break ;
			case '33' : log.innerText = "D#3" ;
			break ;
			case '34' : log.innerText = "E3" ;
			break ;
			case '35' : log.innerText = "F3" ;
			break ;
			case '36' : log.innerText = "F#3" ;
			break ;
			case '37' : log.innerText = "G3" ;
			break ;
			case '38' : log.innerText = "G#3" ;
			break ;
			case '39' : log.innerText = "A3" ;
			break ;
			case '3a' : log.innerText = "A#3" ;
			break ;
			case '3b' : log.innerText = "B3" ;
			break ;
			case '3c' : log.innerText = "C4" ;
			break ;
			case '3d' : log.innerText = "C#4" ;
			break ;
			case '3e' : log.innerText = "D4" ;
			break ;
			case '3f' : log.innerText = "D#4" ;
			break ;
			case '40' : log.innerText = "E4" ;
			break ;
			case '41' : log.innerText = "F4" ;
			break ;
			case '42' : log.innerText = "F#4" ;
			break ;
			case '43' : log.innerText = "G4" ;
			break ;
			case '44' : log.innerText = "G#4" ;
			break ;
			case '45' : log.innerText = "A4" ;
			break ;
			case '46' : log.innerText = "A#4" ;
			break ;
			case '47' : log.innerText = "B4" ;
			break ;
			case '48' : log.innerText = "C5" ;
			break ;
			case '49' : log.innerText = "C#5" ;
			break ;
			case '4a' : log.innerText = "D5" ;
			break ;
			case '4b' : log.innerText = "D#5" ;
			break ;
			case '4c' : log.innerText = "E5" ;
			break ;
			case '4d' : log.innerText = "F5" ;
			break ;
			case '4e' : log.innerText = "F#5" ;
			break ;
			case '4f' : log.innerText = "G5" ;
			break ;
			case '50' : log.innerText = "G#5" ;
			break ;
			case '51' : log.innerText = "A5" ;
			break ;
			case '52' : log.innerText = "A#5" ;
			break ;
			case '53' : log.innerText = "B5" ;
			break ;
			case '54' : log.innerText = "C6" ;
		}

	log.innerText += "\n";
	console.log(ev) ;
}

		var midiMsg = ev.data[1].toString(16) ;
		//socket.emit('midi on', midiMsg) ;
		//conn.send(midiMsg);
		var time = new Date() ;
		console.log('sent ' + midiMsg);

// 		socket.on('latency', function(latency){
// 			var newTime = new Date() ;
// 			var rtt =  newTime - time ;
// 			var oneway = rtt/2 ;
// 			// log.innerText = "latency: " + oneway ;
// });


// Plays the drum note through MIDI output (Apple DLS Synth)
	// if (output)
	// 	output.send( ev.data );
}

function success( midiAccess ) {
	 log.innerText += "MIDI ready!\n";
	midi = midiAccess;

	inputs = midi.inputs();
	log.innerText += inputs.length+" inputs:\n";
	for (var i=0;i<inputs.length;i++)
		log.innerText += i + ": " + inputs[i].name + "\n";

	if (inputs.length>0) {
		input = inputs[0];
		input.onmessage = handleMIDIMessage;
		input.addEventListener("midimessage", handleMIDIMessage);
		log.innerText += inputs[0] + "Hooked up first input.\n";
	}

	outputs = midi.outputs();
	log.innerText += outputs.length+" outputs:\n";
	for (var i=0;i<outputs.length;i++)
		log.innerText += i + ": " + outputs[i].name + "\n";

	if (outputs.length) {
		output = outputs[0];
		output.send( [0xb0, 0x00, 0x7f] );	// If the first device is a Novation Launchpad, this will light it up!
	}
}

function failure( error ) {
	alert( "Failed to initialize MIDI - " + ((error.code==1) ? "permission denied" : ("error code " + error.code)) );
}

</script>


		
		<script src="js/sampleMapping.js"></script>


  Your PeerJS id is : <span id="pid"></span><br><br>
  Connect to peer: <input type="text" id="rid" placeholder="Someone else's id">
                   <input type="button" value="Connect" id="connect"><br><br>
  
  
  <div id="chat_area" style="display: none;">
    <div id="messages"></div>
    <input type="text" id="text" placeholder="Enter message">
    <input type="button" value="Send" id="send">
  </div>
  


	</body>
</html>