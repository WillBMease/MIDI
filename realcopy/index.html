<!doctype html>
<html>
	<head>
		<title> Socket.IO chat </title>

		 <!-- <script src="js/WebMIDIAPI.js"></script>
		// <script src = "js/audioTriggers.js" type = "text/javascript"></script> -->

  <link rel="stylesheet" href="css/style.css">
  <link href="css/fancy.css" rel="stylesheet" type="text/css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script type="text/javascript" src="http://cdn.peerjs.com/0.3/peer.js"></script>

		 <script src="js/WebMIDIAPI.js"></script>
<!-- 		 // <script src="js/videochatroom.js"></script> -->
<!-- 		 // <script src = "js/audioTriggers.js" type = "text/javascript"></script> -->



<script>

 var conn = [] ;
 conn[0] = 0;
 conn[1] = 0;
 conn[2] = 0;
 var x = 0 ;
  // Connect to PeerJS, have server assign an ID instead of providing one
  
  // Generate random ID between 1 and 50 for the user
  var randID = Math.floor(Math.random() * 999) + 1 ;

  // Create a new peer, and assign the randID as "label" in peer
  // the label is assigned automatically by how i passed it in
  // the key connects the peer to the server that does the handshake
  var peer = new Peer(randID, {key: 'lwjd5qra8257b9', debug: true});

  // Open the peer using the randID "label" we assigned
  peer.on('open', function(label){
    $('#pid').text(label);
  });  

  // Await connections from others
  peer.on('connection', connect);

  var startTime ;
  var endTime ;
  var rttTime ;

  // Function called from line above ^
  function connect(c) {

  	//conn[0] = c ;
    $('#chat_area').show();

    x = 0 ;

    // Assign the connection to the user (array for multiple connections?)
    if (conn[0] != 0)
    {
      conn[0].on('data', function(data){
      $('#messages').append('<br>' + conn[0].peer + ':<br>' + data + 'from 0 sender');
      //triggerMidiDevice(data) ;
      //triggerSample1(data) ;
    });

          conn[0].on('close', function(err){ alert(conn.peer + ' has left the chat.') });

		x++ ;
    }

    if (conn[1] != 0)
    {
      conn[1].on('data', function(data){
      $('#messages').append('<br>' + conn[1].peer + ':<br>' + data + 'from 1 sender');
      //triggerMidiDevice(data) ;
      //triggerSample(data) ;

    });

          conn[1].on('close', function(err){ alert(conn.peer + ' has left the chat.') });

      x++ ;
    }

    if (conn[2] != 0)
    {
      conn[2].on('data', function(data){
      $('#messages').append('<br>' + conn[2].peer + ':<br>' + data + 'from 2 sender');
     	//triggerMidiDevice(data) ;
      //triggerSample(data) ;
    });

          conn[2].on('close', function(err){ alert(conn.peer + ' has left the chat.') });

      x++ ;
    }

    conn[x] = c;
    $('#messages').empty().append('Now chatting with ' + conn[x].peer);

    // Receive the incoming message and play it calling midi function
    conn[x].on('data', function(data){
      $('#messages').append('<br>' + conn[x].peer + ':<br>' + data + 'from x sender');

      if (data == '0')
      {
      	var beginLat = new Date();
      	console.log('I received the ping: ' + data);
      	data = '1' ;
      	conn[x].send(data) ;
      	console.log('Now I sent the ping back: ' + data)
      	var endLat = new Date() ;
      	var testing = endLat - beginLat ;
      	console.log('testing: ' + testing) ;
      }

     //  else if (data != '0'){
     // 	//triggerMidiDevice(data) ;
     // 	//triggerSample(data) ;
     // }


      		else if (data[0] == '1')
      		{
      			endTime = new Date();
      			rttTime = (endTime - startTime) / 2 ;
      			console.log('Latency is ' + rttTime + 'ms');
      			var rttString = rttTime.toString() ;
      			console.log('string is' + rttString) ;
       $('#messages').append('<br>You:<br>' + rttString + 'ms');
      		}


      else if (data != '0'){
     	triggerMidiDevice(data) ;
     	//triggerSample(data) ;
     }

    });

    // Close the connection if other peer leaves
    conn[x].on('close', function(err){ alert(conn.peer + ' has left the chat.') });
  }


  $(document).ready(function() {
    // Conect to a peer
    $('#connect').click(function(){
      var c = peer.connect($('#rid').val());
      c.on('open', function(){
        connect(c);
      });
      c.on('error', function(err){ alert(err) });  
    });
   // Send a chat message
    $('#send').click(function(){
      // var msg = $('#text').val();

      startTime = new Date() ;
      var msg = '0' ;

      conn[0].send(msg);
      console.log('I sent the ping: ' + msg);


      // conn[0].on('data', function(data){

      // 		console.log('I got the ping back: ' + data);

      // 		if (data[0] == '0')
      // 		{
      // 			console.log('I should not receive this ping: ' + data);
      // 		}
      // 		else if (data[0] == '1')
      // 		{
      // 			endTime = new Date();
      // 			var rttTime = (endTime - startTime) / 2 ;
      // 			console.log('Latency is ' + rttLatency + 'ms');
      // 			var rttString = rttTime.toString() ;
      // 			console.log('string is' + rttString) ;
      //  $('#messages').append('<br>You:<br>' + rttString + 'ms');
      // 		}
      // 		endTime.clear();
      // });

      $('#text').val('');
    });

    // Show browser version
    $('#browsers').text(navigator.userAgent);
  });

</script>



	</head>

	<body>

<a class = "inavibe">
inavibe</a>
<h2>
<a style "color: white" class = "choose-inst" onClick = "generateNotes(bass)"><i>bass</i>
<a class = "choose-inst" onClick = "generateNotes(harp)"><i>harp</i></a>
<!-- <a class = "choose-inst" onClick = "newGenerateNotes(newHarp)"><i>new harp</i></a> -->
<a class = "choose-inst" onClick = "generateNotes(gPiano)"><i>piano</i></a>
<a class = "choose-inst" onClick = "generateNotes(jazzdrums)"><i>drums</i></a>
<a onclick = "initiateOsc()"><i>synth</i><a>
<a class = "midi-pos" onclick = "runTest();" ><i>midi</i></a>
</h2>
<!-- <h3><a class = "midi-pos-download" href = "http://jazz-soft.net/"> download MIDI support</a></h3> -->
<h4>
	<pre id="log">
	</pre>
	<div class = "midi-pos" id="MIDIPlugin" style="position:absolute; visibility:hidden"></div>
</h4>

<!-- <div class = "latency" onclick = "startLatency()"><i> Start Latency </i></div> -->


<!-- <h1 class = "note-pos">

<i>
	A
</i>
<i>
	B
</i>
<i>
	C
</i>
<i>
	D
</i>
<i>
	E
</i>
<i>
	F
</i>

</h1> -->


</div>
	<ul class="audioBin">
	<li></li>

	</ul>
	<ul class="audioBin1">
	<li></li>

	</ul>
	<ul class="audioBin2">
	<li></li>

	</ul>
</div> 


<!-- 		// <script src = "/socket.io/socket.io.js"></script> -->
		<script src = "http://code.jquery.com/jquery-1.11.1.js"></script>
		<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>-->

<script>

    // conn[0].on('data', function(data){
    //   $('#messages').append('<br>' + conn[0].peer + ':<br>' + data);
    //   playMidi(data) ;
    //   triggerSample(data) ;
    // });

// Create socket
//var socket = io() ;

var octave = 1;
var globalOctave;

//variable used to 
var midiActive = false;
var sampleActive = false;

// initialize web audio api
var context = new (window.AudioContext || window.webkitAudioContext ||  
	window.mozAudioContext || 
    window.oAudioContext || 
    window.msAudioContext)();
if (context) {
  // Web Audio API is available.
} else {
  alert('browser not supported') ;
}

var soundOn ;
var soundOff ;
var isPlaying = false;

var latencyActive = false;
var latencyCount ;
var conn ;


var instrument; 
instrument = '<audio id="" preload="auto">' +
			'</audio>';

//preset instrumemt list/////////////////////////////

var harp = { "name" : "harp", "octaveNum": 8, "notes": 96, "path" : "sounds/Harp"};

// var newHarp = { "name" : "newHarp", "octaveNum": 8, "notes": 97, "path" : "sounds/newHarp"};

var bass = { "name": "bass", "octaveNum": 4, "notes" : 48, "path" : "sounds/E-Bass_Guitar"};

var gPiano = { "name" : "gPiano" , "octaveNum": 8, "notes": 96, "path" : "sounds/Grand_Piano"};

var jazzdrums = { "name" : "drums" , "octaveNum": 2, "notes": 17, "path" : "sounds/jazzdrums"};

$(document).keypress(function(e) { 
if(!sampleActive){
  if (isPlaying) {
  	return; }
  
  isPlaying = true;
	on = e.which;
	// socket.emit('osc on', on);
	return false;
}

else {
	var pressed = e.which;

	if (conn[0] != 0)
	{
		conn[0].send(pressed);
		console.log("send 0");
	}
	if (conn[1] != 0)
	{
		conn[1].send(pressed);
			console.log("send 1");
	}
	if (conn[2] != 0)
	{
		conn[2].send(pressed);
			console.log("send 2");
	}
}

});

//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// OSCILLATOR
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////

function initiateOsc(){
	sampleActive = false;
}

function startNote(soundOn)
{
	oscillator = context.createOscillator(); // Create bass guitar
    gainNode = context.createGainNode(); // Create boost pedal
 
	oscillator.connect(gainNode); // Connect bass guitar to boost pedal
	gainNode.connect(context.destination); // Connect boost pedal to amplifier
	gainNode.gain.value = 0.3; // Set boost pedal to 30 percent volume

	console.log(soundOn) ;

	if (soundOn == 97)
	{
		oscillator.frequency.value = 440.00; // A
		oscillator.noteOn(0); // Play bass guitar instantly
	}
	else if (soundOn == 98)
	{
		oscillator.frequency.value = 493.88; // B
		oscillator.noteOn(0);
	}
	else if (soundOn == 99)
	{
		oscillator.frequency.value = 523.25; // C
		oscillator.noteOn(0);
	}
	else if (soundOn == 100)
	{
		oscillator.frequency.value = 587.33; // D
		oscillator.noteOn(0) ;
	}
	else if (soundOn == 101)
	{
		oscillator.frequency.value = 659.25; // E
		oscillator.noteOn(0) ;
	}

$(document).keyup(function(e){
	off = e.which;
	// socket.emit('osc off', off);
	isPlaying = false ;
	return false;
});
$(document).focus(function(e) { 
  isPlaying = false;
});

// socket.on('osc off', function(msgOff){
// 	endNote(msgOff, oscillator) ;
// });

}

function endNote(soundOff, oscillator)
{
	if (soundOff == 65)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 66)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 67)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 68)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
	else if (soundOff == 69)
	{
		oscillator.noteOff(0); // Play bass guitar instantly
		oscillator.disconnect();
	}
}


//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// SAMPLES
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////



function transpose(noteInput){
	// 1
	if(noteInput == 49 && octave < globalOctave){
		octave = octave + 1;
	}
	// ~
	if(noteInput == 96 && octave != 0){
		octave = octave - 1;
	}
}


function keyGlow(cssClass){
	$('.active').removeClass(active);
	$(this).addClass('active');
	$('.button').click(function(){
	})
}


//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////
// MIDI
//////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////




var midi=null;
var inputs=null;
var outputs=null;
var input=null;
var output=null;
var log=null;

function runTest() {
	if (!log)
		log = document.getElementById("log");
	 log.innerText = "Starting up MIDI...\n";
	navigator.requestMIDIAccess().then( success, failure );
}

function handleMIDIMessage( ev ) {
	
		var midiMsg = [] ;
		midiMsg[0] = ev.data[0].toString(16) ;
		midiMsg[1] = ev.data[1].toString(16) ;
		midiMsg[2] = ev.data[2].toString(16) ;
		//midiMsg[3] = new Date() ;

		if (conn[0] != 0)
		{
		conn[0].send(midiMsg);
		console.log("send 0");
	}
		if (conn[1] != 0)
		{
		conn[1].send(midiMsg);
			console.log("send 1");
		}
		if (conn[2] != 0)
		{
		conn[2].send(midiMsg);
			console.log("send 2");
		}

    // Receive the incoming message and play it calling midi function
    // conn[0].on('data', function(data){
    //   $('#messages').append('<br>' + conn[0].peer + ':<br>' + data);
    //   playMidi(data) ;
    //   triggerSample(data) ;
    // });
    // conn.on('data', function(retLat){
    //   var lat = new Date() ;
    //   var total = lat - retLat[3] ;
    //   console.log ('latency: ' + total) ;
    // });

// Plays the drum note through MIDI output (Apple DLS Synth)
	// if (output)
	// 	output.send( ev.data );
}

function success( midiAccess ) {
	 log.innerText += "MIDI ready!\n";
	midi = midiAccess;

	inputs = midi.inputs();
	log.innerText += inputs.length+" inputs:\n";
	for (var i=0;i<inputs.length;i++)
		log.innerText += i + ": " + inputs[i].name + "\n";

	if (inputs.length>0) {
		input = inputs[0];
		input.onmessage = handleMIDIMessage;
		input.addEventListener("midimessage", handleMIDIMessage);
		log.innerText += inputs[0] + "Hooked up first input.\n";
	}

	outputs = midi.outputs();
	log.innerText += outputs.length+" outputs:\n";
	for (var i=0;i<outputs.length;i++)
		log.innerText += i + ": " + outputs[i].name + "\n";

	if (outputs.length) {
		output = outputs[0];
		output.send( [0xb0, 0x00, 0x7f] );	// If the first device is a Novation Launchpad, this will light it up!
	}
}

function failure( error ) {
	alert( "Failed to initialize MIDI - " + ((error.code==1) ? "permission denied" : ("error code " + error.code)) );
}






function playMidi(midiNote)
{
	if (midiNote[2] != '0')
		{
		console.log("playMidi was called");
		var note;
		note = masterConversion(midiNote);
		playMidiNote(note);
	}
}

</script>


		
		<script src="js/sampleMapping.js"></script>


  Your PeerJS id is : <span id="pid"></span><br><br>
  Connect to peer: <input type="text" id="rid" placeholder="Someone else's id">
                   <input type="button" value="Connect" id="connect"><br><br>
  
  
  <div id="chat_area" style="display: none;">
    <div id="messages"></div>
    <input type="text" id="text" placeholder="Enter message">
    <input type="button" value="Send" id="send">
  </div>
  
  <center>
    <h1>Video Chat Room</h1>
    <div id="mypeerid"></div>
    <input id="remotepeerid" type="text" placeholder="Enter peer id"/>
    <button id="call" type="button">Call</button>
  </center>

  <div id="videos"></div>

	</body>
</html>